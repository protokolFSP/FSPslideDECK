name: Build decks and upload PDFs to Archive.org

on:
  workflow_dispatch:
    inputs:
      max_per_run:
        description: "Maximum transcripts to process this run"
        required: false
        default: "15"
  schedule:
    - cron: "17 2 * * *" # daily 02:17 UTC

jobs:
  build-and-upload:
    runs-on: self-hosted
    permissions:
      contents: write

    env:
      MAX_PER_RUN: ${{ github.event.inputs.max_per_run || '15' }}

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Python + pip available (macOS)
        shell: bash
        run: |
          set -euo pipefail
          python3 --version
          python3 -m pip --version || true

      - name: Install notebooklm-mcp-cli
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install notebooklm-mcp-cli
          nlm --help >/dev/null

      - name: Generate decks (PPTX + PDF)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/generate_decks.sh
          scripts/generate_decks.sh

      - name: Publish outputs to deck-archive branch (git worktree)
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="deck-archive"
          ARCH_DIR=".worktree-deck-archive"

          rm -rf "$ARCH_DIR" || true
          git fetch origin || true

          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
            git worktree add "$ARCH_DIR" "$BRANCH"
          else
            git worktree add --detach "$ARCH_DIR"
            pushd "$ARCH_DIR" >/dev/null
            git checkout --orphan "$BRANCH"
            git rm -rf . >/dev/null 2>&1 || true
            popd >/dev/null
          fi

          mkdir -p "$ARCH_DIR/decks" "$ARCH_DIR/decks_pdf" "$ARCH_DIR/manifest"

          if command -v rsync >/dev/null 2>&1; then
            rsync -a "decks/" "$ARCH_DIR/decks/" || true
            rsync -a "decks_pdf/" "$ARCH_DIR/decks_pdf/" || true
            rsync -a "manifest/" "$ARCH_DIR/manifest/" || true
          else
            cp -R "decks/." "$ARCH_DIR/decks/" || true
            cp -R "decks_pdf/." "$ARCH_DIR/decks_pdf/" || true
            cp -R "manifest/." "$ARCH_DIR/manifest/" || true
          fi

          pushd "$ARCH_DIR" >/dev/null
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Archive decks: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push -u origin "$BRANCH"
          fi
          popd >/dev/null

          git worktree remove "$ARCH_DIR" --force

      - name: Upload PDFs to Archive.org (FSPslide)
        uses: Nick2bad4u/internet-archive-upload@v1.6
        with:
          access-key: ${{ secrets.IA_ACCESS_KEY }}
          secret-key: ${{ secrets.IA_SECRET_KEY }}
          identifier: FSPslide
          files: "decks_pdf/*.pdf"
